<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MU/TH/UR 6000 - REQUISITION TERMINAL</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
/* CSS styles remain exactly the same as they were provided in your file */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #000;
  color: #00ff00;
  font-family: 'Orbitron', monospace;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}

/* CRT Effect */
body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: repeating-linear-gradient(
    0deg,
    rgba(0, 255, 0, 0.03) 0px,
    transparent 1px,
    transparent 2px,
    rgba(0, 255, 0, 0.03) 3px
  );
  pointer-events: none;
  z-index: 1000;
  animation: scanline 8s linear infinite;
}

@keyframes scanline {
  0% { transform: translateY(0); }
  100% { transform: translateY(100vh); }
}

.terminal {
  max-width: 900px;
  margin: 0 auto;
  padding: 40px 20px;
  box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
  border: 2px solid #00ff00;
  position: relative;
}

.header {
  text-align: center;
  border-bottom: 2px solid #00ff00;
  padding-bottom: 15px;
  margin-bottom: 30px;
}

.header h1 {
  font-size: 2.2em;
  letter-spacing: 8px;
  text-shadow: 0 0 10px #00ff00;
  margin-bottom: 5px;
}

.header .subline {
  font-size: 0.9em;
  opacity: 0.8;
  letter-spacing: 2px;
}

.section-title {
  font-size: 1.5em;
  border-bottom: 1px solid rgba(0, 255, 0, 0.5);
  padding-bottom: 10px;
  margin: 40px 0 20px 0;
  text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
}

.status-bar {
  display: flex;
  justify-content: space-between;
  background: rgba(0, 255, 0, 0.1);
  padding: 10px 20px;
  border: 1px solid #00ff00;
  margin-bottom: 30px;
}

.status-item {
  text-align: center;
}

.status-label {
  font-size: 0.7em;
  opacity: 0.6;
  margin-bottom: 3px;
}

.status-value {
  font-size: 1em;
  font-weight: 700;
}

#funds-display {
  color: #ffcc00; /* Yellow for funds */
}

.form-group {
  margin-bottom: 20px;
}

label {
  display: block;
  margin-bottom: 8px;
  font-weight: 700;
  color: #00ff00;
}

select, input[type="text"], button {
  width: 100%;
  padding: 12px;
  margin-top: 5px;
  background: rgba(0, 0, 0, 0.8);
  border: 1px solid #00ff00;
  color: #00ff00;
  font-family: 'Orbitron', monospace;
  font-size: 1em;
  box-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
}

button {
  background: #00ff00;
  color: #000;
  cursor: pointer;
  transition: background-color 0.2s, color 0.2s;
  font-weight: 900;
  margin-top: 20px;
}

button:hover {
  background: #00cc00;
}

/* Objectives Display */
.objective-card {
  border: 1px solid #00ff00;
  padding: 15px;
  margin-bottom: 15px;
  background: rgba(0, 255, 0, 0.05);
  box-shadow: 0 0 5px rgba(0, 255, 0, 0.2);
}

.objective-card h3 {
  font-size: 1.1em;
  margin-bottom: 8px;
  letter-spacing: 1px;
}

.objective-card p {
  font-size: 0.9em;
  line-height: 1.5;
  margin-bottom: 10px;
  opacity: 0.8;
}

.objective-details {
  display: flex;
  justify-content: space-between;
  font-size: 0.8em;
  border-top: 1px dashed rgba(0, 255, 0, 0.3);
  padding-top: 5px;
}

.objective-details .status-tag {
  padding: 3px 8px;
  border-radius: 2px;
  font-weight: 700;
}

.status-active {
  color: #ffff00;
  border: 1px solid #ffff00;
}

.status-completed {
  color: #666;
  border: 1px solid #666;
}

.priority-HIGH { color: #ff0000; }
.priority-MEDIUM { color: #ffff00; }
.priority-LOW { color: #00ff00; }

/* Requisition History */
#history-list {
  list-style: none;
  padding: 0;
}

#history-list li {
  border-bottom: 1px dashed rgba(0, 255, 0, 0.3);
  padding: 8px 0;
  font-size: 0.9em;
}

.req-approved { color: #00ff00; }
.req-denied { color: #ff0000; }
.req-pending { color: #ffff00; }
.req-pending::before { content: '⏳ '; }
.req-approved::before { content: '✅ '; }
.req-denied::before { content: '❌ '; }


/* Gear List */
.gear-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  font-size: 0.9em;
}

.gear-table th, .gear-table td {
  border: 1px solid rgba(0, 255, 0, 0.3);
  padding: 8px;
  text-align: left;
}

.gear-table th {
  background: rgba(0, 255, 0, 0.1);
  font-weight: 700;
  color: #00ff00;
}

.gear-table tr:hover {
  background: rgba(0, 255, 0, 0.05);
}

.flicker {
  animation: flicker 3s infinite;
}

@keyframes flicker {
  0%, 100% { opacity: 1; }
  41.99% { opacity: 1; }
  42% { opacity: 0.8; }
  43% { opacity: 1; }
  45.99% { opacity: 1; }
  46% { opacity: 0.7; }
  46.5% { opacity: 1; }
}

.footer {
  text-align: center;
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid #00ff00;
  font-size: 0.7em;
  opacity: 0.6;
}

.login-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.login-box {
  background: #000;
  border: 2px solid #ffcc00;
  padding: 40px;
  box-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
  text-align: center;
}

.login-box h2 {
  color: #ffcc00;
  margin-bottom: 20px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .terminal {
    padding: 20px 10px;
  }
  .header h1 {
    font-size: 1.5em;
    letter-spacing: 4px;
  }
  .section-title {
    font-size: 1.2em;
  }
  .status-bar {
    flex-direction: column;
    gap: 10px;
  }
  .objective-details {
    flex-direction: column;
    gap: 5px;
  }
}
</style>
</head>
<body>

<div id="login-modal" class="login-modal">
  <div class="login-box">
    <h2><span style="color:#ffcc00;">MU/TH/UR</span> ACCESS</h2>
    <div class="form-group">
        <label for="callsign-select">SELECT CALLSIGN</label>
        <select id="callsign-select">
            <option value="Ripley">Ripley</option>
            <option value="Hicks">Hicks</option>
            <option value="Hudson">Hudson</option>
            <option value="Vasquez">Vasquez</option>
        </select>
    </div>
    <button id="login-button">LOG IN</button>
  </div>
</div>

<div class="terminal flicker" id="main-terminal" style="display:none;">
    <div class="header">
        <h1>MU/TH/UR 6000</h1>
        <div class="subline">REQUISITION & MISSION CONTROL TERMINAL</div>
        <div class="subline" id="user-callsign"></div>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <div class="status-label">MISSION STATUS</div>
            <div class="status-value" style="color: #ff0000;">ALERT LEVEL <span style="font-weight: 900;">ALPHA</span></div>
        </div>
        <div class="status-item">
            <div class="status-label">CURRENT FUNDS</div>
            <div class="status-value" id="funds-display">LOADING...</div>
        </div>
        <div class="status-item">
            <div class="status-label">DATABASE SYNC</div>
            <div class="status-value" style="color: #00ff00;">ONLINE</div>
        </div>
    </div>
    
    <div class="section-title">ACTIVE MISSION OBJECTIVES</div>
    
    <div id="active-objectives-list">
        <p style="opacity: 0.6; font-style: italic;">Awaiting mission data...</p>
    </div>

    <div class="section-title">REQUISITION GEAR</div>

    <form id="requisition-form">
        <div class="form-group">
            <label for="gear-select">SELECT GEAR</label>
            <select id="gear-select">
                </select>
        </div>
        <button type="submit">SUBMIT REQUISITION</button>
    </form>
    
    <div class="section-title">REQUISITION HISTORY</div>
    <ul id="history-list">
        <li style="opacity: 0.6; font-style: italic;">No recent requisitions.</li>
    </ul>

    <div class="section-title">CURRENT GEAR LIST (For Reference)</div>
    <table class="gear-table">
        <thead>
            <tr>
                <th>Item</th>
                <th>Cost</th>
                <th>Priority</th>
            </tr>
        </thead>
        <tbody id="gear-table-body">
            </tbody>
    </table>

    <div class="footer">
        MU/TH/UR 6000 | USCMC OPERATIONS TERMINAL | V 2.1<br>
        ALL SYSTEMS GO - STAND BY FOR INSTRUCTIONS
    </div>
</div>
    
<script type="module">
import { 
    initializeApp 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
    getDatabase, 
    ref, 
    set, 
    onValue, 
    push, 
    update
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// ⭐ FIREBASE CONFIGURATION (Placeholder from previous context)
const firebaseConfig = {
  apiKey: "AIzaSyAn3oG0z19XbBqy5nzwhCtsqK64rNDeJQA",
  authDomain: "muthr6000.firebaseapp.com",
  databaseURL: "https://muthr6000-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "muthr6000",
  storageBucket: "muthr6000.firebasestorage.app",
  messagingSenderId: "483667325658",
  appId: "1:483667325658:web:e79eef575c1586cc456be3",
  measurementId: "G-F4LZB5JF9T"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentFunds = 0;
let currentUser = '';
let gearData = {};
let historyData = [];

// DOM Elements
const fundsDisplay = document.getElementById('funds-display');
const userCallsignDisplay = document.getElementById('user-callsign');
const loginModal = document.getElementById('login-modal');
const mainTerminal = document.getElementById('main-terminal');
const callsignSelect = document.getElementById('callsign-select');
const loginButton = document.getElementById('login-button');
const gearSelect = document.getElementById('gear-select');
const gearTableBody = document.getElementById('gear-table-body');
const historyList = document.getElementById('history-list');
const requisitionForm = document.getElementById('requisition-form');
// ⭐ OBJECTIVE LIST CONTAINER 
const objectivesContainer = document.getElementById('active-objectives-list'); 

// ---------------------------------------------------
// FUND MANAGEMENT
// ---------------------------------------------------

function updateFundsDisplay() {
    fundsDisplay.textContent = `${currentFunds} CR`;
}

function saveUserFunds(callsign, funds) {
    localStorage.setItem(`funds_${callsign}`, funds);
}

function loadUserFunds(callsign) {
    const savedFunds = localStorage.getItem(`funds_${callsign}`);
    if (savedFunds !== null) {
        currentFunds = parseInt(savedFunds, 10);
    } else {
        // Default starting funds
        currentFunds = 1000; 
        saveUserFunds(callsign, currentFunds);
    }
    updateFundsDisplay();
}

// ---------------------------------------------------
// LOGIN LOGIC
// ---------------------------------------------------

loginButton.addEventListener('click', () => {
    currentUser = callsignSelect.value;
    if (currentUser) {
        loginModal.style.display = 'none';
        mainTerminal.style.display = 'block';
        userCallsignDisplay.textContent = `OPERATOR: ${currentUser}`;
        loadUserFunds(currentUser);
        
        // Start Firebase listeners only after successful login
        setupFirebaseListeners();
    }
});

// ---------------------------------------------------
// FIREBASE LISTENERS
// ---------------------------------------------------

function setupFirebaseListeners() {
    // 1. Listen for Gear Data
    onValue(ref(db, 'gear'), (snapshot) => {
        gearData = snapshot.val() || {};
        updateGearDisplay(gearData);
    });

    // 2. Listen for Requisition Requests (History)
    onValue(ref(db, 'requests'), (snapshot) => {
        historyData = [];
        const requests = snapshot.val();
        
        if (requests) {
            Object.entries(requests).forEach(([id, request]) => {
                if (request.callsign === currentUser) {
                    historyData.push({ id, ...request });
                }
            });
            // Sort by timestamp descending
            historyData.sort((a, b) => b.timestamp - a.timestamp);
        }
        updateHistoryDisplay(historyData);
    });
    
    // 3. Listen for Active Objectives
    onValue(ref(db, 'objectives'), (snapshot) => {
        const objectives = snapshot.val();

        // ⭐ THE CRITICAL FIX: Clear the container before re-rendering!
        if (objectivesContainer) {
            objectivesContainer.innerHTML = ''; 
        }

        if (objectives) {
            Object.entries(objectives).forEach(([id, objective]) => {
                const objectiveElement = createObjectiveCard(id, objective);
                objectivesContainer.appendChild(objectiveElement);
            });
        } else {
            // Display fallback message if no objectives are active
            const p = document.createElement('p');
            p.style.opacity = '0.6';
            p.style.fontStyle = 'italic';
            p.textContent = 'Awaiting mission data...';
            objectivesContainer.appendChild(p);
        }
    }, (error) => {
        console.error("Error reading objectives:", error);
    });

    // 4. Listen for status changes to speak results and deduct funds
    let lastSpoken = {};
    onValue(ref(db, 'requests'), (snapshot) => {
      const requests = snapshot.val();
      if (!requests) return;

      Object.entries(requests).forEach(([id, request]) => {
        if (request.status !== 'pending' && lastSpoken[id] !== request.status) {
          lastSpoken[id] = request.status;
          
          // Only deduct funds if approved and for current user
          if (request.status === 'approved' && request.callsign === currentUser) {
            const cost = request.gearCost || 0;
            if (cost > 0) {
              currentFunds -= cost;
              saveUserFunds(currentUser, currentFunds);
              updateFundsDisplay();
            }
            playSuccess();
          } else {
            playError();
          }
          
          const message = request.status === 'approved' 
            ? `Requisition approved. ${request.gear}. Authorization granted.`
            : `Requisition denied. ${request.gear}. Request does not meet operational parameters.`;
          speak(message);
        }
      });
    });
}

// ---------------------------------------------------
// UI UPDATE FUNCTIONS
// ---------------------------------------------------

function updateGearDisplay(gear) {
    // Clear previous options
    gearSelect.innerHTML = '';
    gearTableBody.innerHTML = '';
    
    // Populate select dropdown and table
    Object.entries(gear).forEach(([key, item]) => {
        // Dropdown
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${item.name} (${item.cost} CR) - ${item.priority}`;
        gearSelect.appendChild(option);
        
        // Table
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.cost} CR</td>
            <td class="priority-${item.priority.toUpperCase()}">${item.priority}</td>
        `;
        gearTableBody.appendChild(row);
    });
}

function updateHistoryDisplay(history) {
    historyList.innerHTML = '';
    if (history.length === 0) {
        historyList.innerHTML = '<li style="opacity: 0.6; font-style: italic;">No recent requisitions.</li>';
        return;
    }
    
    history.forEach(request => {
        const li = document.createElement('li');
        const statusClass = `req-${request.status}`;
        const date = new Date(request.timestamp).toLocaleTimeString();
        
        li.className = statusClass;
        li.innerHTML = `
            <span style="font-weight: 700;">[${request.status.toUpperCase()}]</span> 
            ${request.gear} (${request.gearCost} CR) 
            <span style="opacity: 0.5;">@ ${date}</span>
        `;
        historyList.appendChild(li);
    });
}

function createObjectiveCard(id, objective) {
    const card = document.createElement('div');
    card.className = 'objective-card';
    card.innerHTML = `
        <h3>${objective.title}</h3>
        <p>${objective.description}</p>
        <div class="objective-details">
            <span class="priority-${objective.priority.toUpperCase()}">Priority: ${objective.priority.toUpperCase()}</span>
            <span class="status-tag status-${objective.status}">${objective.status.toUpperCase()}</span>
        </div>
    `;
    return card;
}


// ---------------------------------------------------
// REQUISITION SUBMISSION
// ---------------------------------------------------

requisitionForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const selectedGearKey = gearSelect.value;
    const selectedGear = gearData[selectedGearKey];
    
    if (!selectedGear) {
        alert("Please select a valid gear item.");
        return;
    }
    
    if (currentFunds < selectedGear.cost) {
        speak(`Requisition denied. Insufficient funds. ${currentFunds} credits remaining.`);
        playError();
        return;
    }
    
    const newRequest = {
        callsign: currentUser,
        gear: selectedGear.name,
        gearCost: selectedGear.cost,
        priority: selectedGear.priority,
        timestamp: Date.now(),
        status: 'pending' // GM must approve
    };
    
    try {
        await push(ref(db, 'requests'), newRequest);
        speak(`Request submitted for ${selectedGear.name}. Awaiting authorization from Command.`);
        playSuccess();
    } catch (error) {
        console.error("Error submitting request:", error);
        speak("Error submitting request. MU/TH/UR reports a communications failure.");
        playError();
    }
});


// ---------------------------------------------------
// TEXT-TO-SPEECH (MU/TH/UR Voice)
// ---------------------------------------------------

let femaleVoice = null;

function findFemaleVoice(voices) {
  femaleVoice = voices.find(voice => 
    voice.name.toLowerCase().includes('female') || 
    voice.name.toLowerCase().includes('zira') || // Common Windows voice
    voice.name.toLowerCase().includes('samantha') || // Common Mac voice
    voice.default && voice.lang.includes('en') // Fallback to default
  );
  // Further fallback to the first English voice
  if (!femaleVoice) {
    femaleVoice = voices.find(voice => voice.lang.includes('en'));
  }
}

function speak(text) {
    if (!('speechSynthesis' in window)) return;
    
    const utterance = new SpeechSynthesisUtterance(text);
    
    // Ensure voice is loaded
    if (!femaleVoice) {
        const voices = speechSynthesis.getVoices();
        findFemaleVoice(voices);
    }

    if (femaleVoice) {
      utterance.voice = femaleVoice;
      utterance.rate = 0.85;  // Slightly slower
      utterance.pitch = 1.1;  // Higher pitch for more feminine
      speechSynthesis.speak(utterance);
    }
}

function playSuccess() {
    // Console log for non-audio testing
    console.log("Audio: Success tone played.");
}

function playError() {
    // Console log for non-audio testing
    console.log("Audio: Error tone played.");
}

// Load voices
if ('speechSynthesis' in window) {
    speechSynthesis.getVoices();
    window.speechSynthesis.onvoiceschanged = () => {
      findFemaleVoice(speechSynthesis.getVoices());
    };
}


</script>

</body>
</html>
